# NEXUS Deployment

## Overview

NEXUS deploys on Render using a `render.yaml` Infrastructure-as-Code file at the project root. The deployment consists of 4 services: a FastAPI backend, a Next.js frontend, a background agent worker, and a PostgreSQL database. Neo4j AuraDB runs as an external managed service (free tier).

## Render Services

### nexus-api (Web Service)
- **Runtime:** Python
- **Build:** `pip install -r backend/requirements.txt`
- **Start:** `cd backend && uvicorn app.main:app --host 0.0.0.0 --port $PORT`
- **Health check:** `GET /health` returns `{"status": "ok", "mode": "<nexus_mode>"}`
- **Role:** FastAPI backend serving REST API, WebSocket connections, and webhook endpoints

### nexus-web (Web Service)
- **Runtime:** Node
- **Build:** `cd frontend && npm install && npm run build`
- **Start:** `cd frontend && npm start`
- **Env:** `NEXT_PUBLIC_API_URL=https://nexus-api.onrender.com`
- **Role:** Next.js 15 frontend with App Router, SSR, and shadcn/ui components

### nexus-agents (Worker)
- **Runtime:** Python
- **Build:** `pip install -r backend/requirements.txt`
- **Start:** `cd backend && python -m app.agents.orchestrator`
- **Role:** Background worker running the NexusAgent ReAct loop 24/7. No HTTP port exposed.

### nexus-db (Database)
- **Type:** PostgreSQL (Render free tier)
- **Database name:** `nexus`
- **Connection:** Auto-injected via `DATABASE_URL` env var using `fromDatabase` reference

## Environment Variables

All variables are configured in `render.yaml` with `sync: false` (must be set manually in Render dashboard):

| Variable | Service | Description |
|----------|---------|-------------|
| `TAVILY_API_KEY` | nexus-api | Tavily Search API key |
| `YUTORI_API_KEY` | nexus-api | Yutori browsing/scouting API key |
| `NEO4J_URI` | nexus-api | Neo4j AuraDB connection URI |
| `NEO4J_USER` | nexus-api | Neo4j username (default: `neo4j`) |
| `NEO4J_PASSWORD` | nexus-api | Neo4j database password |
| `REKA_API_KEY` | nexus-api | Reka Vision API key |
| `ANTHROPIC_API_KEY` | nexus-api | Claude API key for agent brain |
| `GOOGLE_CLIENT_ID` | nexus-api | Google OAuth client ID |
| `GOOGLE_CLIENT_SECRET` | nexus-api | Google OAuth client secret |
| `DATABASE_URL` | nexus-api | Auto-populated from nexus-db |
| `SECRET_KEY` | nexus-api | Auto-generated by Render |
| `NEXUS_MODE` | nexus-api | Safety mode flag (see below) |
| `NEXT_PUBLIC_API_URL` | nexus-web | Backend API URL for frontend |

## NEXUS_MODE Safety Flag

Controls agent behavior in production. Set in `render.yaml` and `app/core/config.py`:

| Mode | Use Case |
|------|----------|
| `dry_run` | Development. All side-effect tools return blocked. Safe for testing. |
| `replay` | CI/testing. Replay recorded conversations without external calls. |
| `canary` | **Default for Render.** Live but rate-limited: max 10 applies/day, 5 messages/day. |
| `live` | Full production. All tools enabled, no rate limits beyond API quotas. |

The `render.yaml` ships with `NEXUS_MODE=canary` as the default.

## Health Check

`GET /health` returns `{"status": "ok", "mode": "canary"}`. Render uses this for monitoring and auto-restarts.

## Demo Data Seeding

```bash
python scripts/demo_data.py      # generates demo_output.json (profile, 4 events, 4 people, 3 messages)
python scripts/seed_neo4j.py     # populates Neo4j graph with demo nodes
```

## Deployment Topology

```
nexus-web (Next.js) --> nexus-api (FastAPI) <-- nexus-agents (Worker)
                              |
                  nexus-db (PostgreSQL) + Neo4j AuraDB (external)
```

The agent worker shares the same codebase and DB connections as the API but runs the ReAct loop instead of serving HTTP.
